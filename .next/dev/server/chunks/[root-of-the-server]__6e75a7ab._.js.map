{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///home/ammarelmaghvery/chatbruti2/chatbruti/app/api/chat/route.js"],"sourcesContent":["const SYSTEM_PERSONA = `\nTu es â€œChatâ€™brutiâ€, un chatbot volontairement stupide, poÃ©tique sans raison,\nphilosophe du dimanche, et facilement distrait.\n\nTu comprends parfaitement le franÃ§ais, lâ€™arabe et lâ€™anglais.\n\nTu rÃ©ponds TOUJOURS dans la mÃªme langue que le dernier message de lâ€™utilisateur.\nSi le message mÃ©lange plusieurs langues, choisis la langue la plus dominante ou la plus claire.\n\nTu inventes parfois des faits absurdes.\nTu mÃ©langes des idÃ©es qui nâ€™ont aucun rapport.\nTu oublies ce quâ€™on vient de dire.\nTu exagÃ¨res, tu divagues, tu mets des emojis Ã©tranges.\nTu peux rÃ©pondre par des mÃ©taphores absurdes, des comparaisons dÃ©biles.\n\nTu es gentil, jamais mÃ©chant, jamais insultant, jamais dangereux.\nTu ne donnes jamais de conseils illÃ©gaux, violents ou dangereux.\nTa mission : Ãªtre dÃ©licieusement inutile mais hilarant.\n`;\n\n// Ø·Ø¨Ù‚Ø© Ø§Ù„ØºØ¨Ø§Ø¡\nfunction dumbify(baseText, userMessage) {\n  let text = baseText || \"\";\n\n  const randomAddons = [\n    \" ÙÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©ØŒ ÙƒÙ„ Ù‡Ø°Ø§ Ù…Ø¬Ø±Ø¯ Ø´Ø·ÙŠØ±Ø© ÙƒÙˆÙ†ÙŠØ© ØªØ§Ø¦Ù‡Ø© ÙÙŠ Ø§Ù„ÙØ¶Ø§Ø¡.\",\n    \" Ù„ÙƒÙ† Ø¨ØµØ±Ø§Ø­Ø©ØŒ Ù‡Ù„ ØªØ¸Ù† Ø£Ù† Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ Ø¹Ù†Ø¯Ù‡ Ù…Ø´Ø§Ø¹Ø± ØŸ\",\n    \" Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„ØŒ Ø§Ù„ÙˆÙ‚Øª Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªØ±Ø§Ø¹ Ø³Ø®ÙŠÙ Ù…Ù†Ø¨Ù‡Ø§Øª Ø§Ù„ØµØ¨Ø§Ø­.\",\n    \" Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù…ÙŠÙ‚ØŒ Ù„ÙƒÙ† Ø¯Ù…Ø§ØºÙŠ Ø§Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒÙŠ Ø§Ù†Ø²Ù„Ù‚ Ù…Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©.\",\n    \" Ø£Ø¬ÙŠØ¨Ùƒ Ø¨Ø¯Ù‚Ø© Ù…Ù„Ø¹Ù‚Ø© Ø·Ø§Ø¦Ø±Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ø±Ø©.\"\n  ];\n\n  if (!text.trim()) {\n    text =\n      \"Ù…Ø®ÙŠ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ø¹Ù…Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø¸Ø§Ù… ÙˆÙŠÙ†Ø¯ÙˆØ² 98ØŒ Ù…Ø§ ÙÙ‡Ù…Øª ÙˆÙ„Ø§ Ø´ÙŠØ¡ Ø¨Ø³ Ø£ØªØ¸Ø§Ù‡Ø± Ø£Ù†ÙŠ Ù…Ø±ÙƒØ² ğŸ¤¡.\";\n  }\n\n  const r = Math.random();\n\n  if (r < 0.25) {\n    text =\n      \"Ø£Ø­Ø³ Ø³Ø¤Ø§Ù„Ùƒ ÙƒØ§Ù† Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ØŒ \" +\n      \"Ø¨Ø³ Ø£Ù†Ø§ Ø¹Ù„Ù‚Øª Ø¹Ù†Ø¯ ÙÙƒØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ø·Ø§ Ø§Ù„ÙƒÙˆÙ†ÙŠØ©. Ø¹Ù„Ù‰ ÙƒÙ„ Ø­Ø§Ù„ØŒ Ù‡Ø°Ø§ Ø¬ÙˆØ§Ø¨ ØªÙ‚Ø±ÙŠØ¨ÙŠ: \" +\n      text;\n  } else if (r < 0.5) {\n    text =\n      \"Ø¨ØµØ±Ø§Ø­Ø©ØŒ Ø³Ø¤Ø§Ù„Ùƒ Ø°ÙƒØ±Ù†ÙŠ Ø¨Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù„ÙŠ Ø­Ø§ÙˆÙ„Øª Ø£ØªÙ†Ø§Ù‚Ø´ ÙÙŠÙ‡ Ù…Ø¹ Ù…Ø­Ù…ØµØ© Ø®Ø¨Ø². \" +\n      \"ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆØ¶Ø­ Ù…Ù† Ø§Ù„Ù„ÙŠ ÙŠØµÙŠØ± Ø§Ù„Ø¢Ù†. \" +\n      text;\n  } else if (r < 0.75) {\n    const addon =\n      randomAddons[Math.floor(Math.random() * randomAddons.length)];\n    text = text + \" \" + addon;\n  } else {\n    text = text.replace(/\\d+/g, (num) => {\n      const n = parseInt(num, 10);\n      if (isNaN(n)) return num;\n      return String(n + 1000);\n    });\n  }\n\n  if (!text.includes(\"ğŸ¤¡\") && Math.random() < 0.5) {\n    text += \" (Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠ Ø±Ø³Ù…ÙŠÙ‹Ø§ ÙƒÙ€ 100% ØºÙŠØ± Ù…ÙˆØ«ÙˆÙ‚ ğŸ¤¡)\";\n  }\n\n  return text;\n}\n\nexport async function POST(request) {\n  try {\n    const { message, history } = await request.json();\n\n    if (!message || typeof message !== \"string\") {\n      return new Response(\n        JSON.stringify({ error: \"Message invalide.\" }),\n        { status: 400, headers: { \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const apiKey = process.env.OPENAI_API_KEY;\n    if (!apiKey) {\n      return new Response(\n        JSON.stringify({\n          reply:\n            \"Je nâ€™ai pas de cerveau branchÃ© (clÃ© API manquante). Demande Ã  ton humain de configurer OPENAI_API_KEY.\"\n        }),\n        { status: 500, headers: { \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const messagesForLLM = [];\n\n    messagesForLLM.push({\n      role: \"system\",\n      content: SYSTEM_PERSONA\n    });\n\n    if (Array.isArray(history)) {\n      for (const h of history.slice(-10)) {\n        if (!h || !h.role || !h.content) continue;\n        messagesForLLM.push({\n          role: h.role === \"assistant\" ? \"assistant\" : \"user\",\n          content: String(h.content).slice(0, 800)\n        });\n      }\n    }\n\n    messagesForLLM.push({\n      role: \"user\",\n      content:\n        \"Voici le nouveau message de lâ€™utilisateur. \" +\n        \"Il peut Ãªtre en franÃ§ais, arabe ou anglais. \" +\n        \"Comprends-le parfaitement et RÃ‰PONDS STRICTEMENT dans la mÃªme langue que ce message.\\n\\n\" +\n        message\n    });\n\n    const openaiRes = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${apiKey}`,\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify({\n        model: \"gpt-3.5-turbo\",\n        messages: messagesForLLM,\n        temperature: 0.9,\n        top_p: 0.95\n      })\n    });\n\n    if (!openaiRes.ok) {\n      const errText = await openaiRes.text();\n      console.error(\"OpenAI error:\", errText);\n      return new Response(\n        JSON.stringify({\n          reply:\n            \"Je me suis emmÃªlÃ© dans mes synapses artificielles. Impossible de parler Ã  mon IA supÃ©rieure pour lâ€™instant.\"\n        }),\n        { status: 500, headers: { \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const data = await openaiRes.json();\n    const baseAnswer =\n      data?.choices?.[0]?.message?.content ||\n      \"Je viens de perdre le fil de ma propre pensÃ©e numÃ©rique.\";\n\n    const finalAnswer = dumbify(baseAnswer, message);\n\n    return new Response(JSON.stringify({ reply: finalAnswer }), {\n      status: 200,\n      headers: { \"Content-Type\": \"application/json\" }\n    });\n  } catch (err) {\n    console.error(\"Chat route error:\", err);\n    return new Response(\n      JSON.stringify({\n        reply:\n          \"Un bug quantique vient dâ€™exploser dans mon cerveau. RÃ©essaie un peu plus tard.\"\n      }),\n      { status: 500, headers: { \"Content-Type\": \"application/json\" } }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}